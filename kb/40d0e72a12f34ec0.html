<html>
<head>
  <title>Installer</title>
  <meta http-equiv="Content-Type" content="text/html; charset=windows-1251" />
  <link type="text/css" href="css/css.css" rel="stylesheet" />
  <link type="text/css" href="css/sh.css" rel="stylesheet" />
  <script language="javascript" src="js/shInit.js"></script>
  <script language="javascript" src="js/shCore.js"></script>
  <script language="javascript" src="js/shBrushDelphi.js"></script>
  <script language="javascript" src="js/shBrushSql.js"></script>
</head>
<body>
<div id="layout">
<div id="header">
  <div id="logo"><img id="logo" src="img/logo.png" /></div>
  <div id="navigation">
    <p id="navigation">
      <a class="navigation" onclick="prev();" href="#">Предыдущая</a><br />
      <a class="navigation" onclick="up();" href="#">Наверх</a><br />
      <a class="navigation" onclick="next();" href="#">Следующая</a>
    </p>
  </div>
</div>
<div id="content">
<div id="explorer">DRKB Explorer</div>
  <h1 id="title">Installer</h1>
<div id="date">01.01.2010</div>
<!-- Actual content start -->

<p>Этапы инсталляции </p>

<p>Дальше</p>

<p>Запомните одно важное правило: инсталлировать программу можно с человеческих носителей </p>
<p>(винчестеры, компакт-диски, ZIP-диски) и с дискет :) Если вы собираетесь написать инсталляцию</p>
<p> с дискет, которая явно не поместиться на одну дискету, то у вас есть шанс хорошо провести время :) </p>

<p>Как вы знаете, Windows сбрасывает ненужную ей в данный момент информацию на диск.</p>
<p>Это правильно, но это касается данных. Программы никогда на диск не сбрасываются, </p>
<p>поскольку в Windows сегмент кода программы не может быть изменён. Когда Windows </p>
<p>нужна память и ей под руку подворачивается ваша программа, она её просто выкидывает &#8212; и всё. </p>
<p>Когда ваша программа снова становиться нужна, Windows снова загружает её из выполняемого файла. </p>

<p>Эта в высшей степени корректная техника перестаёт работать при инсталляции с дискет. </p>
<p>Ваша программа, например, копирует четвёртую дискету и тут выясняется, что у неё (у программы) </p>
<p>пропал кусок кода. Какие проблемы? &#8212; Windows пытается прочитать файл a:\setup.exe </p>
<p>и естественно его не находит (на четвёртой-то дискете? откуда?). </p>

<p>Только не паникуйте! Эта проблема давно решена, иначе вы не могли бы установить</p>
<p> на свой компьютер ни одной программы! Всё очень просто &#8212; программа инсталляции копирует</p>
<p> себя и все необходимые файлы во временный каталог на жёсткий диск и перезапускает</p>
<p> себя с жёсткого диска. Это и есть первый этап инсталляции. </p>
<p> В зарубежных программах он обычно называется "Prepare to install". </p>
<p> Ещё раз обратите внимание на то, что совсем не обязательно выполнять этот этап,</p>
<p>  если вы инсталлируетесь не с дискет, или если ваша инсталляция умещается на одну дискету. </p>

<p>На втором этапе программа инсталляции обычно показывает пользователю несколько страшных </p>
<p>предупреждений; что-то типа "если вы не заплатите за эту программу, то сидеть вам в тюрьме три пожизненных срока". </p>
<p>Я слышал, что некоторые пользователи со слабым сердецем даже умирали за компьютером от таких угроз :) </p>

<p>Реализация этого этапа до идиотизма тривиальна, поэтому мы и не будем на нём останавливаться подробно. </p>

<p>Следущий этап &#8212; третий. Здесь программа установки дотошно выспрашивает у пользователя кучу</p>
<p> всяких важных данных: имя пользователя и его огранизацию, тип установки, куда будем ставить, </p>
<p>как будет называться группа программ и так далее. На этом этапе нам встретятся некоторые технические</p>
<p> трудности, но их несложно обойти. </p>

<p>Четвёртый этап &#8212; копирование. Конечно, это не очень сложно, но некоторые проблемы у нас всё-таки возникнут.</p>
<p> Во-первых, надо проверить наличие свободного места на целевом диске. Во-вторых, надо удостовериться, </p>
<p>что у нас есть доступ к нужному каталогу. В-третьих, надо проверять, нет ли уже такого файла... </p>
<p>Вы ещё не передумали писать программу инсталляции? </p>

<p>Следующий, пятый, этап &#8212; настройка системного реестра (registry).</p>
<p> Достаточно тривиальная процедура, правда, при инсталляции большого продукта, записывать придёться очень много. </p>

<p>Предпоследний, шестой, этап, заключается в создании группы программ в меню "Пуск".</p>
<p> Или, возможно, вы захотите вынести ярлык на рабочий стол. </p>

<p>Наконец, финальная часть включает демонстрацию нескольких файлов (например, readme), </p>
<p>затем онлайновую регистрацию (подробно на ней я останавливаться не буду) и последнее </p>
<p>сообщение "Инсталляция успешно завершена". </p>

<p>Теперь мы можем перейти к подробному рассмотрению этапов. Сейчас вы узнаете, как это делается :) </p>

<p>Копирование программы во временный каталог </p>

<pre name="code" class="delphi">
program Setup;
 
uses
  Windows,
  SysUtils;
 
const
  ReRunParameter = '/install_from_temp_directory';
 
var
  TempPath: array [0..MAX_PATH] of Char;
  SrcPath: String;
 
begin
  if ParamStr(1) = ReRunParameter then
    SrcPath := ParamStr(2)
  else
    if GetDriveType(PChar(ParamStr(0)[1] + ':\')) = DRIVE_REMOVABLE then
    begin
      // Если программа была запущена без ключа и с дискеты, то
      // копируем её во временный каталог и перезапускам
      // Текущее приложение завершаем.
      GetTempPath(MAX_PATH, TempPath);
      // Добавлям к пути временного каталога символ '\', если его там нет
      if (StrLen(TempPath) &gt; 0) and (TempPath[StrLen(TempPath)] &lt;&gt; '\') then
        StrCat(TempPath, '\');
      // Копируем файл через вызов функции CopyFile из WinAPI
      CopyFile(PChar(ParamStr(0)), PChar(String(TempPath) + ExtractFileName(ParamStr(0))), False);
      // Запускаем файл с двумя параметрами
      WinExec(PChar(String(TempPath) + ExtractFileName(ParamStr(0)) + ' ' +
        ReRunParameter + ' ' + ExtractFilePath(ParamStr(0))), CmdShow);
      Exit;
    end
    else
      SrcPath := ExtractFilePath(ParamStr(0));
  // Здесь начинается программа инсталляции
  // Переменная SrcPath показывает нам, откуда надо копировать файлы
end. 
</pre>

<p>Есть две грабли, на которые можно наступить в приведённом примере.</p>
<p> Первые лежат в вызове функции GetTempPath. </p>
<p>Если у вас нет переменных окружения TMP и TEMP, </p>
<p>то временным каталогом станет текущий каталог программы, то есть, фактически, ваша дискета. </p>

<p>Вы можете проверять, не находится ли временный каталог на</p>
<p> сменном диске (с помощью вызова GetDriveType), и, если находиться, </p>
<p>считать временным каталогом C:\TEMP (если его нет &#8212; создайте самостоятельно). </p>

<p>Вторые грабли заключаются в том, что после завершения инсталляции программу</p>
<p> из временного каталога желательно удалить, но сделать этого вы не сможете, </p>
<p>поскольку программа в этот момент выполняется. Вспомните, что в Windows 95 и Windows NT </p>
<p>выполняющуся программу удалять нельзя</p>

<p>В общем случае, решения этой проблемы я не знаю. Собственно, поскольку файл</p>
<p> останется во временном каталоге, он будет одним из первых кандидатов на удаление </p>
<p>(если пользователь хоть когда-нибудь чистит свой временный каталог :) </p>
<p>Тем не менее, есть один хитрый способ удаления этого файла, о котором я расскажу ниже,</p>
<p>в параграфе о деинсталляции. </p>

<p id="note">Примечание: Если для вас важен размер вашей инсталляции, вы можете взять только тот кусочек,</p>
<p> который приведён выше, и сделать из него отдельную программу (которая будет очень небольшого объёма). </p>
<p>Саму программу инсталляции вы предварительно сжимаете, а перед запуском распаковываете </p>
<p>её во временный каталог (а не копируете, как это сделано здесь).</p>
<p> Обратите внимание, что в этом случае программа должна распаковываться в любом случае, </p>
<p>а не только если она запущена с дискеты. </p>

<p>Запугивание пользователя законами об авторских правах </p>

<p>Да, есть и такой этап. Если&nbsp; вам всё равно придётся вывести небольшое окно и поставить пользователя в известность о </p>
<p>том, что вы не отвечаете за все неприятности, которые могут с ним произойти во время использования вашей программы. </p>

<p>Как это делается? Если вы не знаете, как сделать диалоговое окно, то, </p>
<p>по моему, вам ещё рано писать инсталляции. Если знаете, то выведите окно и поместите в нём нужный текст. </p>

<p>Как получить важные системные данные </p>

<p>На четвёртом этапе нам потребуются некоторые системные данные: имя пользователя и организация, </p>
<p>путь, куда потребуется инсталлировать программу и некоторые другие. Сейчас мы разберёмся, </p>
<p>как и откуда эти данные можно получить. </p>

<p>Имя пользователя и организация </p>

<p>Во время инсталляции, программы иногда запрашивают имя пользователя и его организацию.</p>
<p> Возможно, для работы вашей программы эти данные не понадобятся, но если они вам нужны, вы должны их запросить.</p>
<p> Как правило, программа инсталляции берёт эти данные из Windows </p>
<p>(поскольку при установке Windows пользователь их уже вводил) и просит всего лишь изменить их, </p>
<p>если это необходимо. Наш вопрос звучит так: где Windows хранит имя пользователя и организацию? </p>
<p>Я, правду сказать, не знаю. Но, пробежавшись по реестру, я обнаружил всего лишь два подходящих места, </p>
<p>содержащих эту информацию. </p>
<p>HKEY_LOCAL_MACHINE\Software\Microsoft NT\Windows\CurrentVersion\ </p>
<p>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\</p>
<p>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\</p>
<p>RegisteredOwner = 'Имя' </p>
<p>RegisteredOrganization = 'Организация' </p>
<p>В доступной мне версии Windows 95, эти значения хранятся в ветке </p>
<p>HKEY_LOCAL_MACHINE, а в Windows NT &#8212; HKEY_CURRENT_USER (в подветках Windows или Windows NT). </p>
<p>Поскольку в этом вопросе нет ясности :) я предлагаю проверять обе ветки.</p>
<p> Версию операционной системы можно узнать с помощью функции GetVersionEx. </p>

<p>Куда копировать программу:</p>

<p>Можно сформулировать наш вопрос и по другому: где находиться каталог Program Files? </p>
<p>Некоторые инсталляции считают, что это C:\Program Files. В действительности, конечно, </p>
<p>он может находиться на другом диске, поэтому мы попробуем поискать его по другому... в реестре. </p>

<p>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\ ProgramFilesDir = 'D:\Program Files' </p>

<p>Можно воспользоваться функцией SHGetSpecialFolderLocation (это даже более корректно с точки зрения Microsoft). </p>
<p>Пример использования этой функции вы обнаружите несколькими файлами позже. </p>
<p>Для изменения каталога вы можете вызывать функции SelectDirectory или SHBrowseForFolder.</p>
<p> Можно также создать собственное окно диалога "Выбор каталога" с помощью компонента DirectoryListBox.</p>
<p> Подробнее о выборе каталога мы поговорим позднее, когда будем рассматривать тонкости процесса инсталляции. </p>

<p>Сколько осталось свободного места на диске </p>

<p>Программа инсталляции перед копированием файлов обязана проверить, </p>
<p>сколько на целевом диске осталось свободного дискового пространства. </p>
<p>Это делается при помощью функции GetDiskFreeSpace (из модуля Windows) или функции DiskFree (из модуля SysUtils).</p>
<p> Вторая функция &#8212; это надстройка Delphi над Win API (в смысле, она вызывает GetDiskFreeSpace),</p>
<p> но у неё значительно меньше параметров. </p>

<p>Группы программ </p>

<p>Обычно программа инсталляции создаёт для новой программы новую группу.</p>
<p> Как правило, когда вы вводите название группы, рядом присутствует список,</p>
<p> в котром перечислены все существующие группы. Получить такой список можно двумя способами. </p>
<p>Один из них &#8212; работа с DDE-сервером, который называется Program Manager.</p>
<p> Этот способ мы подробно рассмотрим чуть позже. Второй способ не очень сложен и </p>
<p>основан на том факте, что всё меню "Программы" находиться в одном из каталогов вашего диска. </p>
<p>Все подменю являются на самом деле подкаталогами, а пукнты &#8212; обычными ссылками</p>
<p> (файлами с расширением .lnk). Путь к папке, содержащей меню "Программы", </p>
<p>вы можете найти в реестре:</p>
<p> HKEY_CURRENT_USER\Software\Microsoft\Windows\ CurrentVersion\Explorer\Shell Folders\ Programs = </p>
<p>'D:\WINNT\Profiles\mark\Главное меню\Программы'</p>
<p> Не очень сложно прочитать содержимое этого каталога с помощью функций FindFirst/FindNext. </p>
<p>Ниже мы и об этом поговорим подробнее, поскольку чтение содержимого каталогов потребуется</p>
<p> нам при написании универсальной процедуры копирования файлов. </p>

<p>Дальше</p>

<p id="author">Автор: Неизвестен URL: www.delphi.agava.ru </p>

<p>Взято с сайта <a href="http://blackman.wp-club.net/" target="_blank">http://blackman.wp-club.net/</a></p>

</div>
<!-- Actual content end -->
<hr />
<div id="footer">
<p>&copy; DRKB Library, 2010<br />Разработка и поддержка &mdash; <a href="http://www.drkb.ru/" target="_blank">Quadr0</a></p>
</div>
</div>
</body>
</html>
